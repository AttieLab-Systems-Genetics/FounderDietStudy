---
title: "Founder Diet Study Data"
author: "Brian Yandell"
date: "2022-12-05"
output: html_document
params:
  dataset:
    label: "Measurement Set"
    value: plasma
    input: select
    choices: [physio, plasma, liver]
  traits:
    label: "Number of traits"
    value: 3
    input: slider
    min: 2
    max: 6
    
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      comment = "", fig.width = 7, fig.height = 7)
```

```{r}
library(tidyverse)
library(readxl)
library(readr)
```

```{r}
meas <- readRDS("traits.rds") %>%
  filter(datatype %in% params$dataset)
measum <- readRDS("traitsum.rds") %>%
  filter(datatype %in% params$dataset) %>%
  arrange(strain.sex.diet)
```

```{r}
traits <- measum$trait[seq_len(as.integer(params$traits))]
meas <- meas %>% 
  filter(trait %in% traits)
```

Here we pick out 6 compounds with the lowest absolute value and compares sex, diet and strain.

```{r warnings = FALSE}
ggplot(meas %>%
         unite(sex_diet, sex, diet)) +
  aes(sex_diet, value, col = sex_diet) +
  geom_jitter() +
  facet_grid(trait ~ strain, scales = "free_y") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
dat <- meas %>%
  filter(trait %in% traits[1:2]) %>%
  select(strain, number, sex, diet, trait, value) %>%
  pivot_wider(names_from = "trait", values_from = "value")
load("data/CCcolors.RData")
plotly::ggplotly(
  ggplot(dat) +
    aes(.data[[traits[1]]], .data[[traits[2]]], color = strain) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point(size = 2) +
    scale_color_manual(values = CCcolors) +
    facet_grid(sex ~ diet, scales = "free")) 
```

## More than two pairs

This works for 3 but gets crowded for more

```{r}
traitpairs <- as.data.frame(combn(traits, 2))
dat <- 
  bind_rows(
    map(
      traitpairs,
      function(x) {
        meas %>%
          filter(trait %in% x) %>%
          mutate(trait = c("left","right")[match(trait, x)]) %>%
          select(strain, number, sex, diet, trait, value) %>%
          pivot_wider(names_from = "trait", values_from = "value")
      }),
    .id = "pair") %>%
  unite(sex_diet, sex, diet) %>%
  mutate(pair1 = as.matrix(traitpairs)[1, pair],
         pair2 = as.matrix(traitpairs)[2, pair]) %>%
  select(pair1, pair2, everything())

plotly::ggplotly(
  ggplot(dat) +
    aes(left, right, color = strain) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point(size = 2) +
    scale_color_manual(values = CCcolors) +
    facet_grid(pair2 + pair1 ~ sex_diet, scales = "free"))
```

## Other ideas

Replaced variability in order (which does not really work) with
p_overall something like `broom::tidy(stats::anova(fitfull, fitred))`
where fitfull has model 

`trait ~ strain * sex * diet`

and fitred has model

`trait ~ strain + sex * diet`

That is, we remove overall strain effect but combine `strain:sex`, `strain:diet` and `strain:sex:diet`.

```{r}
tmp <- meas %>% filter(trait == traits[1])
formful <- formula(value ~ strain * sex * diet)
fitful <- stats::lm(formful, tmp)
formred <- formula(value ~ strain + sex * diet)
fitred <- stats::lm(formred, tmp)
      
(broom::tidy(stats::anova(fitred, fitful)) %>%
  select(p.value))[2,]
```

