---
title: "Time Measurements"
author: "Brian Yandell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
runtime: shiny
params:
  echo: no
resource_files:
- traitData.rds
- traitSignal.rds
- traitStats.rds
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
#devtools::install_github("byandell/foundr")
```

# Traits over time

```{r}
setwd("~/Documents/Research/attie_alan/FounderDietStudy/")
```

```{r}
traitData <- readRDS("traitData.rds")
traitSignal <- readRDS("traitSignal.rds")
traitStats <- readRDS("traitStats.rds")
```

```{r}
dtraits <- foundr::timetraits(traitSignal, "week")
```

```{r}
traitTime <- foundr::traitTimes(traitData, traitSignal,
                           "Physio: BW",
                           "cellmean", "week")
```

```{r}
print(plot(traitTime))
```

```{r}
traitTime <- foundr::traitTimes(traitData, traitSignal,
                           c("Physio: BW", "Physio: BL"),
                           "cellmean", "week")
```

```{r}
print(foundr::ggplot_traitTimes(traitTime, facet_strain = TRUE))
```

```{r}
print(foundr::ggplot_traitTimes(traitTime,
  facet_strain = TRUE))
```

# Shiny Code

```{r}
shiny::fluidRow(
  shiny::column(
    3,
    shiny::selectInput("time", "Time Unit:", c("week", "minute","minsum"))),
  shiny::column(
    3,
    shiny::selectInput("trait", "Trait:", NULL, multiple = TRUE)),
  shiny::column(
    3,
    shiny::checkboxInput("facet_strain", "Facet Strain?", FALSE)),
  shiny::column(
    3,
    shiny::selectInput("response", "Response:", c("value", "cellmean", "signal"))))
```

```{r}
timetraits <- shiny::reactive({
  shiny::req(input$time)
  timecol <- ifelse(input$time == "minsum", "minute", input$time)
  foundr::timetraits(traitSignal, timecol)
})
```

```{r}
shiny::observeEvent(
  timetraits(),
  {
    shiny::updateSelectInput(
      session, "trait",
      choices = timetraits(),
      selected = timetraits()[1])
})
```

```{r}
traitTime <- shiny::reactive({
  shiny::req(input$trait, input$response, input$time)
  foundr::traitTimes(
    traitData, traitSignal,
    input$trait, input$response, input$time)
})
```

```{r}
shiny::renderPlot({
  print(foundr::ggplot_traitTimes(
    traitTime(),
    facet_strain = input$facet_strain))
})
```

Need to change response to be p.value or SD.

```{r}
traitSum <- shiny::reactive({
  shiny::req(input$trait, input$time)
  foundr::traitTimes(
    traitStats,
    input$trait, "p.value", input$time)
})
```

```{r}
shiny::renderPlot({
  print(foundr::ggplot_traitTimes(
    traitSum(),
    facet_strain = TRUE))
})
```
