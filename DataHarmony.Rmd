---
title: "Data Harmony"
author: "Brian Yandell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(readxl)
library(readr)
library(foundr) # github/byandell/foundr
```

```{r}
for(filename in list.files("R", full.names = TRUE)) {
  source(filename)
}
```


# Harmonize Data

```{r}
links <- read.csv(file.path("data", "source.csv"), fill = TRUE)
```

## Physio: Physiological traits

```{r}
harmonize("Physio", links, PhysioHarmony)
```

## PlaMet: Plasma metabolites

```{r warning = FALSE}
harmonize("PlaMet", links, MetHarmony, skiprows = 4, skipcols = 4)
```

## LivMet: Liver metabolites

```{r warning = FALSE}
harmonize("LivMet", links, MetHarmony, skiprows = 3, skipcols = 5)
```

## LivRna: Liver mRNA expression

The experiment annotation file relates the `number` (identifier for `animal`) to the `sex` and `diet`. Needed for `LivRna`.

```{r}
annotfile <- linkpath("annot", links)
excel_sheets(annotfile)
annot <- read_excel(annotfile) %>%
  mutate(diet = ifelse(as.character(diet_no) == "200339", "HC_LF", "HF_LC"))
```

There is a separate liver annotation file, which relates `ENTREZID` to `SYMBOL`.

```{r}
liverAnnot <- linkpath("liver_annot", links)
liverAnnot <- read_csv(liverAnnot)
```

```{r warning = FALSE}
harmonize("LivRna", links, LivRnaHarmony, annot, liverAnnot)
```

## Enrich: Plasma enrichment over time

```{r}
harmonize("Enrich", links, EnrichHarmony, annot)
```

## Module: WGCNA module eigentraits

See <WGCNA.Rmd> for construction of `traitModule`.

```{r}
traitModule <- readRDS("traitModule.rds")
```

```{r}
harmonize("Module", links, foundr::moduleHarmony,
          traitModule)
```

```{r}
bind_traits(c("Physio","PlaMet","LivMet","LivRna","Module","Enrich"))
```

