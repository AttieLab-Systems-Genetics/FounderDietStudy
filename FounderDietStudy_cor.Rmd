---
title: "Founder Diet Study Correlations"
author: "Brian Yandell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
params:
  dataset:
    label: "Measurement Set"
    value: plasma
    input: select
    choices: [physio, plasma, liver]
  traits:
    label: "Number of traits"
    value: 3
    input: slider
    min: 2
    max: 6
    
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      comment = "", fig.height = 7, fig.width = 7)
```

```{r}
library(tidyverse)
library(readxl)
library(readr)
library(foundr) # github/byandell/foundr
```

# Compare raw and adjusted correlations

```{r}
plasma <- readRDS("traits.rds") %>%
  filter(datatype == "plasma")
```

```{r}
if(file.exists(filerds <- "plasmasignal.rds")) {
  out <- readRDS(filerds)
} else {
  out <- partition(plasma)
  saveRDS(out, filerds)
}
```

```{r}
outw <- out %>%
  select(-mean) %>%
  pivot_wider(names_from = "trait", values_from = "signal")
write.csv(outw, "plasmasignal.csv", row.names = FALSE)
```

```{r}
outv <- 
  left_join(
    plasma %>% select(-datatype),
    out,
    by = c("trait", "strain", "sex"))
```

```{r}
corval <- 
  bind_rows(
    map(
    split(outv, outv$trait),
    function(x) {
      terms <- c("signal","mean")
      as.data.frame(cor(x[,"value"], x[,terms], use = "pair"))
    }),
    .id = "trait")
apply(corval[,-1], 2, summary)
```

Pattern below makes sense because `mean` captures most of `value`, so their correlations range up toward 1. The `signal` has no clear pattern of correlation with `value`. However, `signal` is that part of the `value` consists of the terms `strain:diet` and `strain:diet:sex`, the important part of the signal.

```{r}
GGally::ggpairs(corval[,-1])
```


Spearman rank correlation of residuals after removing `strain*sex` and `diet*sex` effects.
That is, looking at correlation due to `strain*diet` and `strain*diet*sex` effects only.

```{r}
if(file.exists(filerds <- "corsraw.rds")) {
  corsraw <- readRDS(filerds)
} else {
  corsraw <- abscorcalc(plasma)
  saveRDS(corsraw, filerds)  
}
if(file.exists(filerds <- "cors.rds")) {
  cors <- readRDS(filerds)
} else {
  cors <- abscorcalc(out %>% select(-mean) %>% rename(value = "signal"))
  saveRDS(cors, filerds)  
}
```

```{r eval=FALSE}
traitsum <- readRDS("traitsum.rds")
tmp <- (traitsum %>% filter(datatype == "plasma"))$p_signal
pvalr <- matrix(tmp, byrow = TRUE, nrow = length(tmp), ncol = length(tmp))
pvalr <- pvalr[upper.tri(pvalr)]
pvalc <- matrix(tmp, byrow = FALSE, nrow = length(tmp), ncol = length(tmp))
pvalc <- pvalc[upper.tri(pvalc)]
```

```{r eval=FALSE}
dat <- data.frame(cor_raw = corsraw[upper.tri(corsraw)],
                  cor_adj = cors[upper.tri(cors)]) %>%
  mutate(adjgrp = 1 + pmin(3, floor(cor_raw * 4)),
         pvalr = -log10(pvalr),
         pvalc = -log10(pvalc),
         logpmax = pmin(5, pmax(pvalr, pvalc)),
         logpmin = pmin(5, pmin(pvalr, pvalc)))
```

Each point is a pair of traits showing their raw and adjusted (signal only) correlations. Coloring is by the most significant `p_signal`
for the two traits being correlated. This shows essentially no correlation between  until the raw are fairly large (>0.75). 

Find large correlations for `raw` or `cor_adj` and relatively large `logpmax` for `p_signal`. Add these to plots of correlations (black circles) and use for pair
plots below.

```{r eval=FALSE}
rr <- row(cors)[upper.tri(cors)][datsub$index]
cc <- col(cors)[upper.tri(cors)][datsub$index]
traits <- as.character(unique(out$trait))

datsub <- dat %>%
  mutate(index = row_number()) %>%
  filter(cor_adj > 0.8 | cor_raw > 0.8,
         logpmax > 2) %>%
  filter(cor_adj - cor_raw == max(cor_adj - cor_raw) |
         cor_adj - cor_raw == min(cor_adj - cor_raw))
```

```{r eval=FALSE}
datsub <- datsub %>%
  mutate(traitc = traits[cc],
         traitr = traits[rr]) %>%
  purrr::transpose() %>%
  purrr::map(function(x) {
    if(x$pvalc > x$pvalr) {
      # switch row and columne
      tmp <- x$traitc
      x$traitc <- x$traitr
      x$traitr <- tmp
      tmp <- x$pvalc
      x$pvalc <- x$pvalr 
      x$pvalr <- tmp
    }
    x
  }) %>%
  purrr::transpose() %>%
  lapply(unlist) %>%
  as.data.frame() %>%
  rename(pvalx = "pvalr",
         pvaly = "pvalc",
         traitx = "traitr",
         traity = "traitc") %>%
  select(traitx, traity, everything()) %>%
  select(traitx, pvalx, traity, pvaly, cor_raw, cor_adj) %>%
  mutate(across(is.numeric, signif, 3))
```

```{r}
plasmasum <- readRDS("traitsum.rds") %>%
  filter(datatype == "plasma")
```

```{r}
dat <- cor_compare(plasmasum, corsraw, cors)
```

```{r}
ggplot(dat %>% rename(cor_raw = "cor1", cor_adj = "cor2")) +
  aes(cor_raw, cor_adj) +
  geom_hex()
```


```{r}
ggplot(dat %>%
         rename(cor_raw = "cor1", cor_adj = "cor2") %>%
         filter(cor_raw > .75, cor_adj > .75)) +
  aes(cor_raw, cor_adj) +
  geom_hex()
```

```{r}
ggplot(
  dat %>%
    rename(cor_raw = "cor1", cor_adj = "cor2") %>%
    filter(cor_raw > .75, cor_adj > .75) %>%
    mutate(logpmax = pmax(logpvalr, logpvalc)) %>%
    arrange(logpmax)) +
  aes(cor_raw, cor_adj, color = logpmax) +
  geom_point() +
  geom_smooth(col = "black") + 
  scale_colour_gradientn(colours=rainbow(4))
```


```{r eval=FALSE}
p <- ggplot(dat %>%
  arrange(logpmax)) +
  aes(cor_raw, cor_adj, color = logpmax) +
  geom_point() +
  geom_hline(yintercept = 0.5, col = "darkgray") +
  geom_smooth(col = "black") + 
  facet_wrap(~ adjgrp, scales = "free_x") +
  scale_colour_gradientn(colours=rainbow(4))
```

```{r eval=FALSE}
p +
  geom_point(data = datsub, 
    aes(x = cor_raw, y = cor_adj), 
    shape = 21, fill = NA, size = 5, col = "black", stroke = 2)
```

Same plot but coloring by the least significant `p_signal` among a pair of traits.

```{r eval=FALSE}
p <- ggplot(dat %>% arrange(logpmin)) +
  aes(cor_raw, cor_adj, color = logpmin) +
  geom_point() +
  geom_hline(yintercept = 0.5, col = "darkgray") +
  geom_smooth(col = "black") + 
  facet_wrap(~ adjgrp, scales = "free_x") +
  scale_colour_gradientn(colours=rainbow(4))
```

```{r eval=FALSE}
p +
  geom_point(data = datsub, 
    aes(x = cor_raw, y = cor_adj), 
    shape = 21, fill = NA, size = 5, col = "black", stroke = 2)
```

```{r}
datsub <- cor_extreme(plasmasum, dat)
```

```{r}
ggplot_extreme(out, "mean", datsub[1,], condition = "sex + diet")
```

```{r}
ggplot_extreme(out, "signal", datsub[1,], condition = "sex + diet")
```

```{r}
ggplot_extreme(out, "mean", datsub[2,], condition = "sex + diet")
```

```{r}
ggplot_extreme(out, "signal", datsub[2,], condition = "sex + diet")
```


