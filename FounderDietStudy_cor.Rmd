---
title: "Founder Diet Study Correlations"
author: "Brian Yandell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
params:
  dataset:
    label: "Measurement Set"
    value: plasma
    input: select
    choices: [physio, plasma, liver]
  traits:
    label: "Number of traits"
    value: 3
    input: slider
    min: 2
    max: 6
    
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      comment = "", fig.height = 7, fig.width = 7)
```

```{r}
library(tidyverse)
library(readxl)
library(readr)
library(foundr) # github/byandell/foundr
```

# Compare raw and adjusted correlations

```{r}
plasmaData <- readRDS("traitData.rds") %>%
  filter(datatype == "plasma")
```

```{r}
plasmaSignal <- readRDS("plasmaSignal.rds")
```

```{r}
plasmaDataSignal <- 
  left_join(
    plasmaData %>% select(-datatype),
    plasmaSignal,
    by = c("trait", "strain", "sex"))
```

```{r}
corval <- 
  bind_rows(
    map(
    split(plasmaDataSignal, plasmaDataSignal$trait),
    function(x) {
      terms <- c("signal","mean")
      as.data.frame(cor(x[,"value"], x[,terms], use = "pair"))
    }),
    .id = "trait")
apply(corval[,-1], 2, summary)
```

Pattern below makes sense because `mean` captures most of `value`, so their correlations range up toward 1. The `signal` has no clear pattern of correlation with `value`. However, `signal` is that part of the `value` consists of the terms `strain:condition` and `strain:condition:sex`, the important part of the signal.

```{r}
GGally::ggpairs(corval[,-1])
```


Spearman rank correlation of residuals after removing `strain*sex` and `condition*sex` effects.
That is, looking at correlation due to `strain*condition` and `strain*condition*sex` effects only.

```{r}
if(file.exists(filerds <- "corsraw.rds")) {
  corsraw <- readRDS(filerds)
} else {
  corsraw <- abscorcalc(plasmaData)
  saveRDS(corsraw, filerds)  
}
if(file.exists(filerds <- "cors.rds")) {
  cors <- readRDS(filerds)
} else {
  cors <- abscorcalc(plasmaSignal %>% select(-mean) %>% rename(value = "signal"))
  saveRDS(cors, filerds)  
}
```

```{r eval=FALSE}
traitPvalue <- readRDS("traitPvalue.rds")
tmp <- (traitPvalue %>% filter(datatype == "plasma"))$p_signal
pvalr <- matrix(tmp, byrow = TRUE, nrow = length(tmp), ncol = length(tmp))
pvalr <- pvalr[upper.tri(pvalr)]
pvalc <- matrix(tmp, byrow = FALSE, nrow = length(tmp), ncol = length(tmp))
pvalc <- pvalc[upper.tri(pvalc)]
```

Each point is a pair of traits showing their raw and adjusted (signal only) correlations. Coloring is by the most significant `p_signal`
for the two traits being correlated. This shows essentially no correlation between  until the raw are fairly large (>0.75). 

Find large correlations for `raw` or `cor_adj` and relatively large `logpmax` for `p_signal`. Add these to plots of correlations (black circles) and use for pair
plots below.

```{r}
plasmaPvalue <- readRDS("traitPvalue.rds") %>%
  filter(datatype == "plasma")
```

```{r}
dat <- cor_compare(plasmaPvalue, corsraw, cors)
```

```{r}
ggplot(dat %>% rename(cor_raw = "cor1", cor_adj = "cor2")) +
  aes(cor_raw, cor_adj) +
  geom_hex()
```


```{r}
ggplot(dat %>%
         rename(cor_raw = "cor1", cor_adj = "cor2") %>%
         filter(cor_raw > .75, cor_adj > .75)) +
  aes(cor_raw, cor_adj) +
  geom_hex()
```

# Extreme Comparisons Identified by Correlation and P-value

```{r}
datsub <- cor_extreme(plasmaPvalue, dat)
```

```{r}
ggplot_extreme(plasmaSignal, "mean", datsub[1,], condition = "sex + condition")
```

```{r}
ggplot_extreme(plasmaSignal, "signal", datsub[1,], condition = "sex + condition")
```

```{r}
ggplot_extreme(plasmaSignal, "mean", datsub[2,], condition = "sex + condition")
```

```{r}
ggplot_extreme(plasmaSignal, "signal", datsub[2,], condition = "sex + condition")
```

# Correlation Comparisons by P-value

```{r}
ggplot(
  dat %>%
    rename(cor_raw = "cor1", cor_adj = "cor2") %>%
    filter(cor_raw > .75, cor_adj > .75) %>%
    mutate(logpmax = pmax(logpvalr, logpvalc)) %>%
    arrange(logpmax)) +
  aes(cor_raw, cor_adj, color = logpmax) +
  geom_point() +
  geom_smooth(col = "black") + 
  scale_colour_gradientn(colours=rainbow(4))
```


```{r}
ggplot(
  dat %>%
    rename(cor_raw = "cor1", cor_adj = "cor2") %>%
    mutate(logpmax = pmax(logpvalr, logpvalc)) %>%
    arrange(logpmax)) +
  aes(cor_raw, cor_adj, color = logpmax) +
  geom_point() +
  geom_hline(yintercept = 0.5, col = "darkgray") +
  geom_smooth(col = "black") + 
  scale_colour_gradientn(colours=rainbow(4)) +
  geom_point(data = datsub, 
    aes(x = cor1, y = cor2), 
    shape = 21, fill = NA, size = 5, col = "black", stroke = 2)
```

Same plot but coloring by the least significant `p_signal` among a pair of traits.

```{r}
ggplot(dat %>%
    rename(cor_raw = "cor1", cor_adj = "cor2") %>%
    mutate(logpmin = pmin(logpvalr, logpvalc)) %>%
    arrange(logpmin)) +
  aes(cor_raw, cor_adj, color = logpmin) +
  geom_point() +
  geom_hline(yintercept = 0.5, col = "darkgray") +
  geom_smooth(col = "black") + 
  scale_colour_gradientn(colours=rainbow(4)) +
  geom_point(data = datsub, 
    aes(x = cor1, y = cor2), 
    shape = 21, fill = NA, size = 5, col = "black", stroke = 2)
```

