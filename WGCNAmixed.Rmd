---
title: "Mixed Module Study"
author: "Brian Yandell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
params:
  echo: no
  rootdir: ~/founder_diet_study
---

Goal: Study mixed module

Idea: Use shinyContrastModule as template, but with mixed WGCNA instead of contrast WGCNA.
Can do same look at strain contrasts, and also use stats summaries.
Make this a new panel for liver app.
Modules will not be different by sex (M,F,B,C) but can do viz by those;
that is, not 4 sets of WGCNA but 1.
Other difference: mixed WGCNA includes multiple datasets;
want to make sure those datasets are selected.

Done:

- Lipid data has been updated with Holland material.
- traitX.rds files updated on ResearchDrive
- `trait` names modified in MixMod$modules; added `dataset` column
- *** need to add column for missing, and keep names of `trait` and `dataset`
- MixMod added to `traitModule.rds`
- plot of Stats for module working in Stats panel
- contrasts computed for eigens as `MixModCond` below
- traits for module identified below
- add % dropped as characteristic of module
- plot of Contrasts for modules (adapt for shinyContrastSex)

** Not sure how `term` is incorporated or which `p.value` to choose. **

To Do:

- plot of Contrasts for traits within modules (adapt for shinyContrastModule)
- other summaries (including min `p.value` for `term` within module)
- redeploy both web apps with updated Lipid data
- fix up app.. and shiny.. to work with data

Other change to app: customSetting for default stats (strain:diet, or strain if no diet/condition).

# Setup

```{r}
rawdir <- file.path(params$rootdir, "RawData")
(harmonizeddir <- file.path(params$rootdir, "HarmonizedData"))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = harmonizeddir)
```

```{r}
library(foundr)
library(tidyverse)
library(modulr)
```

```{r}
filename <- "traitModule.rds"
traitModule <- readRDS(filename)
```

```{r}
mixmod <- traitModule$MixMod
```

# Module Eigenvalues

```{r}
traitModule$MixMod$value$modules |> filter(dropped) |> arrange(dataset)
```

```{r}
MixModSignal <- readRDS(file.path("MixMod", "MixModSignal.rds")) |>
  mutate(dataset = "MixMod")
MixModStats <- readRDS(file.path("MixMod", "MixModStats.rds")) |>
  mutate(dataset = "MixMod")
```

```{r}
MixModCond <- conditionContrasts(MixModSignal, MixModStats, 
        termname = "strain:diet", rawStats = MixModStats)
```

It seems that `eigen_df` is the killer here, depending on
a particular form for rownames that is not adhered to.
Will take some rethinking.

Right now, `eigen_df` is set up for `c("dataset", "strain", "sex")`,
which is fine for contrasts. It needs to be set up for
`c("strain","sex","condition","animal")`
with special handling of `_` in condition.
This is done in another routine.

Also, do not want to paste `sexes` and `module` to expand `module`.

Goal is to have object from eigen_contrast with columns
"dataset" "strain"  "sex"     "module"  "value"   "kME"     "p.value" "size"    "trait"
Only have a subset of these to begin; others come from `module_info().
Look at what is done for contrast.
may need a whole new routine for imported modules.
Rather than having modules constructed by sex, they are constructed across datasets.
So need to capture dataset and not repeat on sex.

Maybe this is not what we want. We have the `eigens` in MixModCond
across the contrasts. What we want to do is match up these with
MixModSignal and get stats from MixModStats for the eigens.
For the traits, we want to use `modules` to match up `dataset` and `trait`
from traitCond with the module.

```{r}
data.frame(
  Stats = MixModStats |> count(trait) |> count(n, name = "samples"),
  Signal = MixModSignal |> count(trait) |> count(n, name = "samples"),
  Cond = MixModCond |> count(trait) |> count(n, name = "samples"))
```

```{r}
list(
  Stats = names(MixModStats),
  Signal = names(MixModSignal),
  Cond = names(MixModCond))
```

```{r}
MixModCond
```

```{r}
ggplot_conditionContrasts(
        MixModCond, bysex = "Both Sexes",
        ordername = "p.value",
        plottype = "volcano")
```

```{r}
ggplot_conditionContrasts(
        MixModCond, bysex = "Both Sexes",
        ordername = "p.value",
        threshold = list(p.value = 0.05),
        plottype = "dotplot")
```

```{r}
ggplot_conditionContrasts(
        MixModCond, bysex = "Both Sexes",
        ordername = "p.value",
        threshold = list(p.value = 0.05),
        plottype = "biplot")
```

The `eigen_contrast` left-joins the 

```{r}
MixModInfo <-
    dplyr::ungroup(
      dplyr::summarize(
        dplyr::group_by(
          mixmod$value$modules,
          .data$module),
        kME = signif(max(abs(kME), na.rm = TRUE), 4),
#        p.value = signif(min(p.value, na.rm = TRUE), 4),
        size = dplyr::n(),
        drop = sum(dropped) / size,
        .groups = "drop"))
MixModInfo
```

```{r}
(MixModEigen <- 
    dplyr::mutate(
      dplyr::left_join(
        dplyr::rename(MixModCond, module = "trait"),
        # Get information by module.
        MixModInfo,
        by = "module"),
      trait = factor(.data$module, unique(.data$module)),
      module = match(.data$trait, levels(.data$trait))))
```


```{r eval=FALSE}
MixModEigen <- foundr:::eigen_contrast_dataset(
  traitModule["MixMod"], MixModCond)
```

# Traits in Modules

```{r}
MixDataTraits <- unite(filter(mixmod$value$modules, !dropped),
                       datatrait, dataset, trait, sep = ": ")
```

```{r}
traitStats <- readRDS("liverStats.rds") |>
  unite(datatrait, dataset, trait, sep = ": ", remove = FALSE) |>
  filter(datatrait %in% MixDataTraits$datatrait) |>
  select(-datatrait)
```

```{r}
pivot_wider(count(
  left_join(
    distinct(traitStats, dataset, trait),
    MixDataTraits,
    by = dataset, trait),
  mutate(dropped = ifelse(dropped, "Drop", "Keep")),
  dataset, dropped),
  names_from = "dropped", values_from = "n")
```

Pick out traits for module `thistle4`

**Need to add module as initial trait.**

```{r}
module_id <- "thistle4"
```

```{r}
readRDS("liverStats.rds") |>
  unite(datatrait, dataset, trait, sep = ": ", remove = FALSE) |>
  filter(datatrait %in%
           filter(MixDataTraits, module == module_id)$datatrait) |>
  filter(term == "strain:diet") |>
  select(-term, -SD) |>
  left_join(
    MixDataTraits,
    by = "datatrait") |>
  select(-datatrait) |>
  arrange(p.value) 
```

** Not sure if following is right. We want contrasts for traits in module.
want to run conditionContrasts on Signal and Stats from module. **

```{r}
MixModCond <- conditionContrasts(MixModSignal, MixModStats, 
        termname = "strain:diet", rawStats = MixModStats)
```



```{r}
readRDS("liverSignal.rds") |>
  unite(datatrait, dataset, trait, sep = ": ", remove = FALSE) |>
  filter(datatrait %in%
           filter(MixDataTraits, module == module_id)$datatrait) |>
  left_join(
    MixDataTraits,
    by = "datatrait") |>
  select(-datatrait) |>
  arrange(p.value) 
```

```{r}
MixModCond |>
  filter(trait == module_id)
```

```{r}
MixModEigen |> filter(trait == module_id)
```

# Modules as Traits

```{r}
PhysioSignal <- readRDS(file.path("Physio", "PhysioSignal.rds")) |>
  mutate(dataset = "Physio")
PhysioStats <- readRDS(file.path("Physio", "PhysioStats.rds")) |>
  mutate(dataset = "Physio")
```

```{r}
traitModule$Physio$Female$modules
```

```{r}
PhysioCond <- conditionContrasts(PhysioSignal, PhysioStats, 
        termname = "strain:diet", rawStats = PhysioStats)
PhysioEigen <- foundr:::eigen_contrast_dataset(
  traitModule["Physio"], PhysioCond)
```

```{r}
PhysioCond
```

```{r}
PhysioEigen
```

```{r}
PhysioDatatraits <- tidyr::unite(PhysioEigen, datatraits, dataset, trait,
                   sep = ": ")$datatraits
```

```{r}
Physio_traits <- foundr:::eigen_traits_dataset(traitModule, "Both Sexes",
                                               PhysioDatatraits[1],
                              PhysioCond, PhysioEigen)
```

```{r}
Physio_traits
```

```{r}
ggplot_conditionContrasts(
        PhysioCond, bysex = "Female",
        ordername = "p.value",
        plottype = "volcano")
```

