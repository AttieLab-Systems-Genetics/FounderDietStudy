---
title: "Founder Diet Study Data"
author: "Brian Yandell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      comment = "", fig.width = 7, fig.height = 7)
```
 
```{r}
library(tidyverse)
library(readxl)
library(readr)
library(foundr) # github/byandell/foundr
```

Data for this repository are identified by `data/source.csv`,
which is not saved with the repo.

```{r}
links <- read_csv(file.path("data", "source.csv"))
```

Data comes from Google Drive <`r linkpath("google", links)`>.
See the QC Analysis Report on liver RNAseq data (in zip file under folder `Liver RNAseq`).
# Physiological trait counts by strain, sex, diet

```{r}
physiofile <- linkpath("physio", links)
excel_sheets(physiofile)
```

```{r}
physiodef <- read_excel(physiofile, sheet = 1, skip = 1) %>%
  unite("comment", -(1:3)) %>%
  mutate(comment = str_remove(str_replace_all(
    str_remove_all(comment, "NA"), "_+", "_"), "^_"))
```

```{r}
if(file.exists(rdsfile <- "physioData.rds")) {
  physioData <- readRDS(rdsfile)
} else {
  physioData <- read_excel(physiofile, sheet = 2) %>%
    pivot_longer(-(1:4), names_to = "trait", values_to = "value") %>%
    mutate(diet = ifelse(as.character(diet) == "200339", "HC_LF", "HF_LC")) %>%
    rename(condition = "diet",
           animal = "number") %>%
    mutate(animal = as.character(animal)) %>%
    select(strain, sex, animal, condition, trait, value) %>%
    # Normal scores by trait
    group_by(trait) %>%
    mutate(value = foundr::nqrank(value, jitter = TRUE)) %>%
    ungroup()
  
  saveRDS(physioData, rdsfile)
}
rm(rdsfile)
```

There are `r nrow(distinct(physioData, trait))` distinct traits.

Count of mice per strain, sex and condition. All combinations have at least some measurements.

```{r}
physioData %>%
  filter(!is.na(value)) %>%
  distinct(strain, animal, sex, condition) %>%
  count(strain, sex, condition) %>%
  unite("sex_condition", sex, condition) %>%
  pivot_wider(names_from = "sex_condition", values_from = "n")
```

Percent missing values across traits

```{r}
physioData %>%
  filter(!is.na(value)) %>%
  count(strain, sex, condition) %>%
  unite("sex_condition", sex, condition) %>%
  mutate(n = round(100 * (1 - n / max(n)), 2)) %>%
  pivot_wider(names_from = "sex_condition", values_from = "n")
```

## Physiological Signals

```{r}
if(file.exists(rdsfile <- "physioSignal.rds")) {
  physioSignal <- readRDS(rdsfile)
} else {
  physioSignal <- partition(physioData)
  
  saveRDS(physioSignal, rdsfile)
}
rm(rdsfile)
```

## Physiological Stats Summaries

```{r}
if(file.exists(rdsfile <- "physioStats.rds")) {
  physioStats <- readRDS(rdsfile)
} else {
  physioStats <- strainstats(physioData)
  
  saveRDS(physioStats, rdsfile)
}
rm(rdsfile)
```

# Plasma metabolite abundance data

```{r}
plasmafile <- linkpath("plasma", links)
excel_sheets(plasmafile)
```

```{r}
if(file.exists(rdsfile <- "plasmaData.rds")) {
  plasmaData <- readRDS(rdsfile)
} else {
  plasmaData <- read_excel(plasmafile, sheet = 1, skip = 4) %>%
    pivot_longer(-(1:4), names_to = "mousecode", values_to = "value") %>%
    mutate(
      strain = str_remove(str_extract(mousecode, "^.*-"), "-"),
      number = str_extract(str_remove(mousecode, "^.*-"), "^[0-9]+"),
      sex = str_extract(str_remove(mousecode, "^.*-[0-9]+_"), "^[MF]"),
      condition = str_remove(str_remove(mousecode, "^.*-[0-9]+_"), "^[MF]_")) %>%
    rename(trait = "compound",
           animal = "number") %>%
    select(strain, sex, animal, condition, trait, value) %>%
    # Normal scores by trait
    group_by(trait) %>%
    mutate(value = foundr::nqrank(value, jitter = TRUE)) %>%
    ungroup()
  
  saveRDS(plasmaData, rdsfile)
}
rm(rdsfile)
```

There are missing data for B6 mice across 3 of the 4 `sex:condition` combinations.

```{r}
plasmaData %>%
  filter(!is.na(value)) %>%
  distinct(strain, animal, sex, condition) %>%
  count(strain, sex, condition) %>%
  unite("sex_condition", sex, condition) %>%
  pivot_wider(names_from = "sex_condition", values_from = "n")
```

Removed plasma data (sheet 1 of spreadsheet) appears to be identical.

```{r}
removed <- read_excel(plasmafile, sheet = 1, skip = 4) %>%
  pivot_longer(-(1:4), names_to = "mousecode", values_to = "value") %>%
  mutate(strain = str_remove(str_extract(mousecode, "^.*-"), "-"),
         animal = str_extract(str_remove(mousecode, "^.*-"), "^[0-9]+"),
         sex = str_extract(str_remove(mousecode, "^.*-[0-9]+_"), "^[MF]"),
         condition = str_remove(str_remove(mousecode, "^.*-[0-9]+_"), "^[MF]_")) %>%
  rename(trait = "compound")
```

```{r}
removed_comp <- (removed %>%
  filter(!is.na(value)) %>%
  count(trait))$trait
plasma_comp <- (plasmaData %>%
  filter(!is.na(value)) %>%
  count(trait))$trait
m <- match(removed_comp, plasma_comp)
sum(is.na(m))
```

```{r}
plasmar <- full_join(
  plasmaData %>% select(strain, animal, sex, condition, trait, value),
  removed %>% select(strain, animal, sex, condition, trait, value),
  by = c("strain", "animal", "sex", "condition", "trait"),
  suffix = c(".p", ".r"))
summary(plasmar$value.p - plasmar$value.r)
```

## Plasma Signals

```{r}
if(file.exists(rdsfile <- "plasmaSignal.rds")) {
  plasmaSignal <- readRDS(rdsfile)
} else {
  plasmaSignal <- partition(plasmaData)
  
  saveRDS(plasmaSignal, rdsfile)
}
rm(rdsfile)
```

## Plasma Stats Summaries

```{r}
if(file.exists(rdsfile <- "plasmaStats.rds")) {
  plasmaStats <- readRDS(rdsfile)
} else {
  plasmaStats <- strainstats(plasmaData)

  saveRDS(plasmaStats, rdsfile)
}
rm(rdsfile)
```

# Mouse annotations

The experiment annotation file relates the `number` (identifier for `animal`) to the `sex` and `diet`.

```{r}
annotfile <- linkpath("annot", links)
excel_sheets(annotfile)
annot <- read_excel(annotfile) %>%
  mutate(diet = ifelse(as.character(diet_no) == "200339", "HC_LF", "HF_LC"))
```

```{r}
annot %>%
  distinct(diet, diet_no, diet_description)
```

```{r}
annot %>%
  count(strain, sex, diet) %>%
  unite("sex_diet", sex, diet) %>%
  pivot_wider(names_from = "sex_diet", values_from = "n")
```

There is a separate liver annotation file, which relates `ENTREZID` to `SYMBOL`.

```{r}
liverAnnot <- linkpath("liver_annot", links)
liverAnnot <- read_csv(liverAnnot)
```

# Liver RNAseq

There are two liver-specific files, for the data and the annotation. 
The liver data file contains the the liver mRNA files tied to the `ENTREZID` (which is in the first column but does not have a column name).
The `liverAnnot` table relates `ENTREZID` to `SYMBOL`; these are combined to create `trait`.
In addition, the experiment annotation file (`annot`) relates the `number` (identifier for `animal`) to the `sex` and `diet` (which is changed to `condition` for harmonization).
Note also that the liver data refers to strain `129` as `A129` to not begin with a number;
this has to be corrected.

```{r}
liverfile <- linkpath("liver", links)
```

```{r}
if(file.exists(rdsfile <- "liverData.rds")) {
  liverData <- readRDS(rdsfile)
} else {
  liverData <- 
    left_join(
      left_join(
        read_csv(liverfile) %>%
          rename(ENTREZID = "...1") %>%
          mutate(ENTREZID = as.character(ENTREZID)) %>%
          pivot_longer(-1, names_to = "strain_number", values_to = "value") %>%
          separate(strain_number, sep = "_", into = c("strain","number")) %>%
          mutate(strain = ifelse(strain == "A129", "129", strain)),
        annot %>%
          mutate(number = as.character(number)),
        by = c("strain", "number")),
      liverAnnot[,-1] %>%
        mutate(ENTREZID = as.character(ENTREZID)),
      by = "ENTREZID") %>%
    filter(value > min(value)) %>% # Minimum is stand-in for missing value.
    rename(animal = "number",
           condition = "diet",
           trait = "SYMBOL") %>%
    mutate(trait = paste(trait, ENTREZID, sep = "_")) %>%
    select(strain, sex, animal, condition, trait, value) %>%
    # Normal scores by trait
    group_by(trait) %>%
    mutate(value = foundr::nqrank(value, jitter = TRUE)) %>%
    ungroup() 

  saveRDS(liverData, rdsfile)
}
rm(rdsfile)
```

Percent missing values

```{r}
liverData %>%
  filter(!is.na(value)) %>%
  count(strain, sex, condition) %>%
  unite("sex_condition", sex, condition) %>%
  mutate(n = round(100 * (1 - n / max(n)), 2)) %>%
  pivot_wider(names_from = "sex_condition", values_from = "n")
```

```{r}
if(file.exists(rdsfile <- "liverSignal.rds")) {
  liverSignal <- readRDS(rdsfile)
} else {
  liverSignal <- partition(liverData)
  
  saveRDS(liverSignal, rdsfile)
}
rm(rdsfile)
```

```{r}
if(file.exists(rdsfile <- "liverStats.rds")) {
  liverStats <- readRDS(rdsfile)
} else {
  liverStats <- strainstats(liverData)
  
  saveRDS(liverStats, rdsfile)
}
rm(rdsfile)
```

# Liver metabolites

```{r}
livermetabfile <- linkpath("liver_metab", links)
```

```{r}
if(file.exists(rdsfile <- "livermetabData.rds")) {
  liverData <- readRDS(rdsfile)
} else {
  livermetabData <- read_excel(livermetabfile, skip = 3)
  liverData <- 
    left_join(
      left_join(
        read_csv(liverfile) %>%
          rename(ENTREZID = "...1") %>%
          mutate(ENTREZID = as.character(ENTREZID)) %>%
          pivot_longer(-1, names_to = "strain_number", values_to = "value") %>%
          separate(strain_number, sep = "_", into = c("strain","number")) %>%
          mutate(strain = ifelse(strain == "A129", "129", strain)),
        annot %>%
          mutate(number = as.character(number)),
        by = c("strain", "number")),
      liverAnnot[,-1] %>%
        mutate(ENTREZID = as.character(ENTREZID)),
      by = "ENTREZID") %>%
    filter(value > min(value)) %>% # Minimum is stand-in for missing value.
    rename(animal = "number",
           condition = "diet",
           trait = "SYMBOL") %>%
    mutate(trait = paste(trait, ENTREZID, sep = "_")) %>%
    select(strain, sex, animal, condition, trait, value) %>%
    # Normal scores by trait
    group_by(trait) %>%
    mutate(value = foundr::nqrank(value, jitter = TRUE)) %>%
    ungroup() 

  saveRDS(liverData, rdsfile)
}
rm(rdsfile)

```

# Trait Compilations

Combine all data together into unified objects.
Drop traits that have missing p-value (due to imbalance of some pathological form).

```{r}
traitStats <- dplyr::bind_rows(
  Physio = readRDS("physioStats.rds"),
  PlaMet = readRDS("plasmaStats.rds"),
  LivRna = readRDS("liverStats.rds"),
  .id = "dataset")

dropTraits <- unique(filter(
  filter(
    traitStats,
    term != "noise"),
  is.na(p.value)))$trait

traitStats <- dplyr::filter(traitStats, !(trait %in% dropTraits))

saveRDS(traitStats, "traitStats.rds")
readr::write_csv(traitStats, "traitStats.csv")

rm(traitStats)

traitData <- dplyr::bind_rows(
  Physio = readRDS("physioData.rds"),
  PlaMet = readRDS("plasmaData.rds"),
  LivRna = readRDS("liverData.rds"),
  .id = "dataset")

traitData <- dplyr::filter(traitData, !(trait %in% dropTraits))

saveRDS(traitData, "traitData.rds")
readr::write_csv(traitData, "traitData.csv")

rm(traitData)

traitSignal <- dplyr::bind_rows(
  Physio = readRDS("physioSignal.rds"),
  PlaMet = readRDS("plasmaSignal.rds"),
  LivRna = readRDS("liverSignal.rds"),
  .id = "dataset")

traitSignal <- dplyr::filter(traitSignal, !(trait %in% dropTraits))

saveRDS(traitSignal, "traitSignal.rds")
readr::write_csv(traitSignal, "traitSignal.csv")

rm(traitSignal)
```


